#!/bin/bash

if [ "$#" -lt 2 ]; then
  echo "Usage: $0 output-file casename [args]"
  exit 1
else
  output=$1
  case_name=$2
  tmp_output=${output}.tmp.$$.toml
  args=
  nargs=1
  for arg in $@; do
    if [ $nargs -gt 2 ]; then
      args="$args $arg" 
    fi
    nargs=$(( $nargs + 1 ))
  done
fi

DEODE_PATH=`python -c 'import deode; print(deode.__path__[0]);'`
PYSURFEX_PATH=`python -c 'import pysurfex; print(pysurfex.__path__[0]);'`
EXPERIMENT_PATH=`python -c 'import experiment; print(experiment.__path__[0]);'`
set -x
deode case --case-name $case_name --config-file $DEODE_PATH/data/config_files/config.toml --output $tmp_output $PYSURFEX_PATH/cfg/config_exp_surfex.toml $EXPERIMENT_PATH/../pysurfex-experiment.toml $args || exit 1

cat $tmp_output | sed -e "s#@PLUGIN_HOME@#$PWD#g" > $output
rm -f $tmp_output

