
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PYSURFEX Experiment documentation &#8212; Pysurfex-experiment  documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="#">Pysurfex-experiment  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">PYSURFEX Experiment documentation</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="pysurfex-experiment-documentation">
<h1>PYSURFEX Experiment documentation<a class="headerlink" href="#pysurfex-experiment-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<img alt="https://coveralls.io/repos/github/metno/pysurfex-experiment/badge.svg?branch=master" id="readme" src="https://coveralls.io/repos/github/metno/pysurfex-experiment/badge.svg?branch=master" />
<p><a class="reference external" href="https://coveralls.io/github/metno/pysurfex-experiment">https://coveralls.io/github/metno/pysurfex-experiment</a></p>
</div>
<div class="section" id="this-repository-is-a-setup-to-create-and-run-offline-surfex-experiments">
<h1>This repository is a setup to create and run offline SURFEX experiments.<a class="headerlink" href="#this-repository-is-a-setup-to-create-and-run-offline-surfex-experiments" title="Permalink to this headline">¶</a></h1>
<p>See online documentation in <a class="reference external" href="https://metno.github.io/pysurfex-experiment/">https://metno.github.io/pysurfex-experiment/</a>
The setup is dependent of pysurfex (<a class="reference external" href="https://metno.github.io/pysurfex">https://metno.github.io/pysurfex</a>)</p>
<p>You need a python3 parser and the following dependencies are needed. Install the non-standard ones e.g. with pip or your system installation system. Requirements can be found in <a class="reference external" href="https://github.com/metno/pysurfex-experiment/blob/master/requirements.txt">https://github.com/metno/pysurfex-experiment/blob/master/requirements.txt</a></p>
<div class="section" id="general-dependencies-from-pypi">
<h2>General dependencies (from pypi)<a class="headerlink" href="#general-dependencies-from-pypi" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pysurfex
</pre></div>
</div>
<p>pysurfex bring extra dependencies like gridpp, titanlib. If you install from pypi with pip these should be handled automatically.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>The recommended installation method is using poetry. First install poetry. This can be done in several ways like a system package or ftom pypi. The recommended way is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -sSL https://install.python-poetry.org <span class="p">|</span> python3 -
</pre></div>
</div>
<p>When you have poetry installed make sure you have it in path. It might be installed in ~/.local/bin.
To install the script system first clone <a class="reference external" href="https://github.com/metno/pysurfex-experiment">https://github.com/metno/pysurfex-experiment</a> and install it.
To run commands interactively in the poetry environment you need to run either “poetry shell” or “poetry run [cmd]”</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
mkdir -p projects
<span class="nb">cd</span> projects

<span class="c1"># Clone the source code</span>
clone https://github.com/metno/pysurfex-experiment

<span class="c1"># Install the script system</span>
<span class="nb">cd</span> pysurfex-experiment
poetry install

<span class="c1"># Enter the environment</span>
poetry shell
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>There are two ways to set up an experiment. Either in an experiment with the config files inside the experiment,
or as a self contained configuration file with all settings inside.</p>
</div>
<div class="section" id="approach-1-all-sub-config-files-in-an-experiment">
<h2>Approach 1: All sub-config files in an experiment<a class="headerlink" href="#approach-1-all-sub-config-files-in-an-experiment" title="Permalink to this headline">¶</a></h2>
<p>Assume you have cloned experiment in pysurfex-experiment-clone-dir. Let us set some variables we can use in the examples in addition to some system settings.
Adjust it to your clone, host-tag and system. First you will set up an experiment. This will merge configuration based on your settings and split them back to configuration files.
You have the following config files in the config directories:</p>
<blockquote>
<div><ul class="simple">
<li><p>config_exp.toml</p></li>
<li><p>config_exp_surfex.toml</p></li>
<li><p>config_exp_observations.toml</p></li>
<li><p>config_exp_eps.toml</p></li>
</ul>
</div></blockquote>
<p>In addition you will get some other config files used in the tasks. An example on how to use it inside a poetry environment (“poetry shell”)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># First make sure you are in a poetry environment after executing &quot;poetry shell&quot;</span>
<span class="nb">cd</span> ~/projects/pysurfex-experiment
poetry shell

<span class="nb">export</span> <span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="o">=</span><span class="s2">&quot;pysurfex-experiment-clone-dir&quot;</span>
<span class="nb">export</span> <span class="nv">HOST_TAG</span><span class="o">=</span><span class="s2">&quot;my-host-tag&quot;</span>
<span class="nb">export</span> <span class="nv">OFFLINE_SOURCE_CODE</span><span class="o">=</span><span class="s2">&quot;path-to-your-offline-source-code&quot;</span>

<span class="nb">cd</span>
mkdir -p sfx_home
<span class="nb">cd</span> sfx_home
mkdir -p my_exp
<span class="nb">cd</span> my_exp

<span class="c1"># The -offline argument is optional if you want to run with existing binaries</span>
PySurfexExpSetup -experiment <span class="nv">$PYSURFEX_EXPERIMENT_PATH</span> -host <span class="nv">$HOST_TAG</span> -offline <span class="nv">$OFFLINE_SOURCE_CODE</span>
<span class="c1"># This will create a file exp_dependencies.json</span>

<span class="c1"># Alternative way of setting up a pre-defined SEKF configuration</span>
PySurfexExpSetup -experiment <span class="nv">$PYSURFEX_EXPERIMENT_PATH</span> -host <span class="nv">$HOST_TAG</span> -offline <span class="nv">$OFFLINE_SOURCE_CODE</span> --config sekf

<span class="c1"># To re-configure your config and (re-)create exp_configuration.json</span>
PySurfexExpConfig

<span class="c1"># To start you experiment</span>
PySurfexExp start -dtg <span class="m">202301010300</span> -dtgend <span class="m">202301010600</span>
</pre></div>
</div>
<p>Alternative 2 is using the poetry run functionality:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># First make sure you are in a poetry environment after executing &quot;poetry shell&quot;</span>
<span class="nb">cd</span> ~/projects/pysurfex-experiment

<span class="nb">export</span> <span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="o">=</span><span class="s2">&quot;pysurfex-experiment-clone-dir&quot;</span>
<span class="nb">export</span> <span class="nv">HOST_TAG</span><span class="o">=</span><span class="s2">&quot;my-host-tag&quot;</span>
<span class="nb">export</span> <span class="nv">OFFLINE_SOURCE_CODE</span><span class="o">=</span><span class="s2">&quot;path-to-your-offline-source-code&quot;</span>
<span class="nb">export</span> <span class="nv">WD</span><span class="o">=</span><span class="nv">$HOME</span>/sfx_home/my_exp

<span class="c1"># The -offline argument is optional if you want to run with existing binaries</span>
poetry run PySurfexExpSetup -experiment <span class="nv">$PYSURFEX_EXPERIMENT_PATH</span> -host <span class="nv">$HOST_TAG</span> -offline <span class="nv">$OFFLINE_SOURCE_CODE</span> -exp_name my_exp --wd <span class="nv">$WD</span>
<span class="c1"># This will create a file exp_dependencies.json</span>

<span class="c1"># Alternative way of setting up a pre-defined SEKF configuration</span>
<span class="nv">WD</span><span class="o">=</span><span class="nv">$HOME</span>/sfx_home/my_sekf_exp
poetry run PySurfexExpSetup -experiment <span class="nv">$PYSURFEX_EXPERIMENT_PATH</span> -host <span class="nv">$HOST_TAG</span> -offline <span class="nv">$OFFLINE_SOURCE_CODE</span> --config sekf -exp_name my_sekf_exp --wd <span class="nv">$WD</span>

<span class="c1"># To re-configure your config and (re-)create exp_configuration.json</span>
poetry run PySurfexExpConfig -exp_name my_sekf_exp --wd <span class="nv">$WD</span>

<span class="c1"># To start you experiment</span>
poetry run PySurfexExp start -dtg <span class="m">202301010300</span> -dtgend <span class="m">202301010600</span>
</pre></div>
</div>
<p>The second approach is to create a self-contained configuration file, can be started.
The altering of the configuration must then be done by applying a defined configuration or a configuration file with patches from original configuration.
Here is an example with CARRA2.</p>
<p>Following host tags are tested:</p>
<blockquote>
<div><ul class="simple">
<li><p>ECMWF-atos (ATOS at ECMWF)</p></li>
<li><p>ppi-rhel8  (RH8 PPI at met.no)</p></li>
<li><p>nebula     (nebula.nsc.liu.se)</p></li>
</ul>
<p>The experiment specific file exp_dependencies.json will tell you the location of the system dependent files.
You might want to override them with local copies if needed.</p>
</div></blockquote>
</div>
<div class="section" id="extra-environment-on-ppi-rhel8-needed-to-start-experiments">
<h2>Extra environment on PPI-RHEL8 needed to start experiments<a class="headerlink" href="#extra-environment-on-ppi-rhel8-needed-to-start-experiments" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module use /modules/MET/rhel8/user-modules/
module load ecflow/5.8.1
<span class="nb">export</span> <span class="nv">ECF_SSL</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">UDUNITS2_XML_PATH</span><span class="o">=</span>/usr/share/udunits/udunits2.xml
</pre></div>
</div>
</div>
<div class="section" id="trainings">
<h2>Trainings<a class="headerlink" href="#trainings" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/metno/pysurfex-experiment/blob/master/trainings/budapest_may_2022.rst/">Budapest May 2022</a> (Old version)</p>
</div>
<div class="section" id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="class-methods">
<h2>Class methods<a class="headerlink" href="#class-methods" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">ref</dt>
<dd class="field-odd"><p><cite>README</cite></p>
</dd>
</dl>
</li>
</ul>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PYSURFEX Experiment documentation</a></li>
<li><a class="reference internal" href="#this-repository-is-a-setup-to-create-and-run-offline-surfex-experiments">This repository is a setup to create and run offline SURFEX experiments.</a><ul>
<li><a class="reference internal" href="#general-dependencies-from-pypi">General dependencies (from pypi)</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#usage">Usage</a></li>
<li><a class="reference internal" href="#approach-1-all-sub-config-files-in-an-experiment">Approach 1: All sub-config files in an experiment</a></li>
<li><a class="reference internal" href="#extra-environment-on-ppi-rhel8-needed-to-start-experiments">Extra environment on PPI-RHEL8 needed to start experiments</a></li>
<li><a class="reference internal" href="#trainings">Trainings</a></li>
<li><a class="reference internal" href="#classes">Classes</a></li>
<li><a class="reference internal" href="#class-methods">Class methods</a></li>
<li><a class="reference internal" href="#methods">Methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="#">Pysurfex-experiment  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">PYSURFEX Experiment documentation</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Trygve Aspelien.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>