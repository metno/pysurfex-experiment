
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PYSURFEX Experiment documentation &#8212; Pysurfex-experiment  documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="contents.html">Pysurfex-experiment  documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="pysurfex-experiment-documentation">
<h1>PYSURFEX Experiment documentation<a class="headerlink" href="#pysurfex-experiment-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<img alt="https://coveralls.io/repos/github/metno/pysurfex-experiment/badge.svg?branch=master" id="readme" src="https://coveralls.io/repos/github/metno/pysurfex-experiment/badge.svg?branch=master" />
<p><a class="reference external" href="https://coveralls.io/github/metno/pysurfex-experiment">https://coveralls.io/github/metno/pysurfex-experiment</a></p>
</div>
<div class="section" id="this-repository-is-a-setup-to-create-and-run-offline-surfex-experiments">
<h1>This repository is a setup to create and run offline SURFEX experiments.<a class="headerlink" href="#this-repository-is-a-setup-to-create-and-run-offline-surfex-experiments" title="Permalink to this headline">¶</a></h1>
<p>See online documentation in <a class="reference external" href="https://metno.github.io/pysurfex-experiment/">https://metno.github.io/pysurfex-experiment/</a>
The setup is dependent of pysurfex (<a class="reference external" href="https://metno.github.io/pysurfex">https://metno.github.io/pysurfex</a>) and pysurfex-scheduler (<a class="reference external" href="https://metno.github.io/pysurfex">https://metno.github.io/pysurfex</a>)</p>
<p>You need a python3 parser and the following dependencies are needed. Install the non-standard ones e.g. with pip or your system installation system. Requirements can be found in <a class="reference external" href="https://github.com/metno/pysurfex-experiment/blob/master/requirements.txt">https://github.com/metno/pysurfex-experiment/blob/master/requirements.txt</a></p>
<div class="section" id="general-dependencies-from-pypi">
<h2>General dependencies (from pypi)<a class="headerlink" href="#general-dependencies-from-pypi" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pysurfex
pysurfex-scheduler
</pre></div>
</div>
<p>pysurfex and pysurfex-scheduler bring extra dependencies like gridpp, titanlib and ecflow. If you install from pypi with pip these should be handled automatically.</p>
</div>
<div class="section" id="code-unit-testing-and-coverage">
<h2>Code unit testing and coverage<a class="headerlink" href="#code-unit-testing-and-coverage" title="Permalink to this headline">¶</a></h2>
<p>Extra dependencies for testing</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>unittest
nose
</pre></div>
</div>
<p>Create coverage/test by executing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./create_coverage.sh
</pre></div>
</div>
<p>Create documentation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> docs
<span class="c1"># Create html documentation</span>
make html
<span class="c1"># Create latex documentation</span>
make latex
<span class="c1"># Create a pdf documentation</span>
make latexpdf
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Assume you have cloned experiment in pysurfex-experiment-clone-dir. Let us set some variables we can use in the examples in addition to some system settings. Adjust it to your clone, host-tag and system</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="o">=</span><span class="s2">&quot;pysurfex-experiment-clone-dir&quot;</span>
<span class="nb">export</span> <span class="nv">HOST_TAG</span><span class="o">=</span><span class="s2">&quot;my-host-tag&quot;</span>
<span class="nb">export</span> <span class="nv">PYSURFEX</span><span class="o">=</span><span class="s2">&quot;path-to-your-pysurfex-installation&quot;</span>
<span class="nb">export</span> <span class="nv">OFFLINE_SOURCE_CODE</span><span class="o">=</span><span class="s2">&quot;path-to-your-offline-source-code&quot;</span>
<span class="nb">export</span> <span class="nv">SCHEDULER_PYTHONPATH</span> <span class="o">=</span> <span class="s2">&quot;path-to-pysurfex-scheduler:path-to-ecflow-python-module&quot;</span>
<span class="nb">export</span> <span class="nv">SCHEDULER_PATH</span><span class="o">=</span><span class="s2">&quot;path-to-ecflow-bin-dir&quot;</span>

<span class="c1"># Set PYTHONPATH</span>
<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span>:<span class="si">${</span><span class="nv">SCHEDULER_PYTHONPATH</span><span class="si">}</span>:<span class="nv">$PYTHONPATH</span>

<span class="c1"># Set PATH</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">SCHEDULER_PATH</span><span class="si">}</span>:<span class="nv">$PATH</span>
</pre></div>
</div>
<p>The reason you need to adjust the path is that the scheduler uses the ecflow start scripts to start the server.
If you have installed PYSURFEX and/or pysurfex-scheduler with pip you might try this to find the installation directories:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -c <span class="s2">&quot;import surfex; print(surfex.__path__[0] + &#39;/..&#39;)&quot;</span>
python -c <span class="s2">&quot;import scheduler; print(scheduler.__path__[0] + &#39;/..&#39;)&quot;</span>
</pre></div>
</div>
<p>Make sure you have the host you want to run on defined in pysurfex-experiment-clone-dir/config/<em>/host-name-tag</em>. There is a file for:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>system -&gt; sym-linked to Env_system in setup</dt>
<dd><ul class="first last">
<li>Definition of experiment structure and system commands. The pythonpath for the scheduler should be defined as SCHEDULER_PYTHONPATH for each host in this file</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>submit -&gt; sym-linked to Env_submit in setup</dt>
<dd><ul class="first last">
<li>Definition of submission of the job tasks, e.g to a batch system</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>server -&gt; sym-linked to  Env_server in setup</dt>
<dd><ul class="first last">
<li>Definition of the scheduler running, e.g an ecflow server</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>env -&gt; sym-linked to Env in setup</dt>
<dd><ul class="first last">
<li>Definition of a host specific environment used in the beginning og job files</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>input_paths -&gt; sym-linked to Env_input_paths in setup</dt>
<dd><ul class="first last">
<li>Definiton of paths and structure of the experiment and input data</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Now you can set up your experiment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
mkdir -p sfx_home
<span class="nb">cd</span> sfx_home
mkdir -p my_exp
<span class="nb">cd</span> my_exp
<span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span>/bin/PySurfexExpSetup <span class="se">\</span>
 -experiment <span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span> <span class="se">\</span>
 -host <span class="si">${</span><span class="nv">HOST_TAG</span><span class="si">}</span> <span class="se">\</span>
 -surfex <span class="si">${</span><span class="nv">PYSURFEX</span><span class="si">}</span> <span class="se">\</span>
 -offline <span class="si">${</span><span class="nv">OFFLINE_SOURCE_CODE</span><span class="si">}</span>
</pre></div>
</div>
<p>You now a experiment which you can modify to your needs. You can choose to run with existing binaries without specifying -offline when setting up and add the proper bin_dir to our Env_input_files file. Instead of the -experiment argument you can also specify a full existing experiment by using the -rev argument.</p>
<p>If you run ecflow with SSL support, remember to add before starting:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">ECF_SSL</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>This must also be added to your job tasks for example in the Env file for communication with your server fom the batch job. Finally you can start your experiment</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./bin/PySurfexExp start -dtg <span class="m">2022020100</span> -dtgend <span class="m">2022020103</span>
</pre></div>
</div>
<p>All batch jobs start from local json files with configuration of server, system and you configuration found on the scratch directory on the whost you run on. It means if you do local configuration changes you will need to either start/continue the run with “PySurfexExp start/prod” or you can execute PySurfexExpConfig and then sync files from HOME on HOST0 to scratch on the used hosts by executing the InitRun task in the scheduler. InitRun alone will not update your configurations, only sync files.</p>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference external" href="https://metno.github.io/pysurfex-experiment/#examples">https://metno.github.io/pysurfex-experiment/#examples</a></p>
</div>
<div class="section" id="trainings">
<h2>Trainings<a class="headerlink" href="#trainings" title="Permalink to this headline">¶</a></h2>
<p><cite>Budapest May 2022 &lt;https://github.com/metno/pysurfex-experiment/blob/master/trainings/budapest_may_2022.rst/&gt;</cite></p>
</div>
</div>
<div class="section" id="eamples-of-running-experiments">
<h1>Eamples of running experiments<a class="headerlink" href="#eamples-of-running-experiments" title="Permalink to this headline">¶</a></h1>
<p>Here are some examples on how to use pysurfex-experiment</p>
<div class="section" id="ppi-centos7-dual-host-bionic-centos7">
<h2>ppi-centos7 (dual-host bionic-centos7)<a class="headerlink" href="#ppi-centos7-dual-host-bionic-centos7" title="Permalink to this headline">¶</a></h2>
<p>First define some system paths to be used:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="o">=</span><span class="s2">&quot;/modules/bionic/user-apps/suv/pysurfex-experiment/0.0.1-dev/&quot;</span>
<span class="nb">export</span> <span class="nv">HOST_TAG</span><span class="o">=</span><span class="s2">&quot;ppi-centos7&quot;</span>
<span class="nb">export</span> <span class="nv">PYSURFEX</span><span class="o">=</span><span class="s2">&quot;/modules/centos7/user-apps/suv/pysurfex/0.0.1-dev/&quot;</span>
<span class="nb">export</span> <span class="nv">OFFLINE_SOURCE_CODE</span><span class="o">=</span><span class="s2">&quot;/modules/SOURCES/centos7-SOURCES/AA_SEKF/util/offline&quot;</span>

 <span class="c1"># Activate environment</span>
<span class="nb">source</span> /modules/bionic/conda/Feb2021/etc/profile.d/conda.sh
conda activate production-04-2021

<span class="nb">export</span> <span class="nv">SCHEDULER_PYTHONPATH</span><span class="o">=</span><span class="s2">&quot;/modules/bionic/user-apps/suv/pysurfex-scheduler/0.0.1-dev/:/modules/bionic/user-apps/ecflow/5.5.2-ssl/lib/python3.6/site-packages&quot;</span>
<span class="nb">export</span> <span class="nv">SCHEDULER_PATH</span><span class="o">=</span><span class="s2">&quot;/modules/bionic/user-apps/ecflow/5.5.2-ssl/bin/&quot;</span>

<span class="c1"># Set PYTHONPATH</span>
<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span>:<span class="si">${</span><span class="nv">SCHEDULER_PYTHONPATH</span><span class="si">}</span>:<span class="nv">$PYTHONPATH</span>

<span class="c1"># Set PATH</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">SCHEDULER_PATH</span><span class="si">}</span>:<span class="nv">$PATH</span>
</pre></div>
</div>
<p>Default configuration on PPI</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
mkdir -p sfx_home
<span class="nb">cd</span> sfx_home
mkdir sandbox
<span class="nb">cd</span> sandbox

<span class="c1"># Set up experiment</span>
<span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span>/bin/PySurfexExpSetup <span class="se">\</span>
                -experiment <span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span> <span class="se">\</span>
                -host <span class="si">${</span><span class="nv">HOST_TAG</span><span class="si">}</span> <span class="se">\</span>
                -surfex <span class="si">${</span><span class="nv">PYSURFEX</span><span class="si">}</span> <span class="se">\</span>
                -offline <span class="si">${</span><span class="nv">OFFLINE_SOURCE_CODE</span><span class="si">}</span>

<span class="c1"># Sett SSL</span>
<span class="nb">export</span> <span class="nv">ECF_SSL</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># Start the experiment</span>
./bin/PySurfexExp start -dtg <span class="m">2022013106</span> -dtgend <span class="m">2022020206</span>
</pre></div>
</div>
<p>Only snow assimilation for a domain around DRAMMEN</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
mkdir -p sfx_home
<span class="nb">cd</span> sfx_home
mkdir DRAMMEN_SNOW_ASS
<span class="nb">cd</span> DRAMMEN_SNOW_ASS

<span class="c1"># Set up experiment</span>
<span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span>/bin/PySurfexExpSetup <span class="se">\</span>
                 -experiment <span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span> <span class="se">\</span>
                 -host <span class="si">${</span><span class="nv">HOST_TAG</span><span class="si">}</span> <span class="se">\</span>
                 -surfex <span class="si">${</span><span class="nv">PYSURFEX</span><span class="si">}</span> <span class="se">\</span>
                 --config_file <span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span>/config/configurations/isba_dif_snow_ass.toml <span class="se">\</span>
                 -offline <span class="si">${</span><span class="nv">OFFLINE_SOURCE_CODE</span><span class="si">}</span>

<span class="c1"># Sett SSL</span>
<span class="nb">export</span> <span class="nv">ECF_SSL</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># Start the experiment</span>
./bin/PySurfexExp start -dtg <span class="m">2022013106</span> -dtgend <span class="m">2022020206</span>
</pre></div>
</div>
</div>
<div class="section" id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="class-methods">
<h2>Class methods<a class="headerlink" href="#class-methods" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">ref:</th><td class="field-body"><cite>README</cite></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PYSURFEX Experiment documentation</a></li>
<li><a class="reference internal" href="#this-repository-is-a-setup-to-create-and-run-offline-surfex-experiments">This repository is a setup to create and run offline SURFEX experiments.</a><ul>
<li><a class="reference internal" href="#general-dependencies-from-pypi">General dependencies (from pypi)</a></li>
<li><a class="reference internal" href="#code-unit-testing-and-coverage">Code unit testing and coverage</a></li>
<li><a class="reference internal" href="#usage">Usage</a></li>
<li><a class="reference internal" href="#examples">Examples</a></li>
<li><a class="reference internal" href="#trainings">Trainings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#eamples-of-running-experiments">Eamples of running experiments</a><ul>
<li><a class="reference internal" href="#ppi-centos7-dual-host-bionic-centos7">ppi-centos7 (dual-host bionic-centos7)</a></li>
<li><a class="reference internal" href="#classes">Classes</a></li>
<li><a class="reference internal" href="#class-methods">Class methods</a></li>
<li><a class="reference internal" href="#methods">Methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="contents.html">Pysurfex-experiment  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Trygve Aspelien.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>